name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ PR title –Ω–∞ conventional commits
  check-pr-title:
    runs-on: ubuntu-latest
    steps:
      - uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # feat, fix, docs, style, refactor, perf, test, build, ci, chore
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
          scopes: |
            auth
            spell
            gateway
            web
            db
            infra
          requireScope: true

  # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–º—ñ—Ä—É PR
  check-pr-size:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          # –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –∑–º—ñ–Ω–µ–Ω–∏—Ö —Ä—è–¥–∫—ñ–≤
          CHANGED_LINES=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')
          echo "Changed lines: $CHANGED_LINES"

          # –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è —è–∫—â–æ PR –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π
          if [ "$CHANGED_LINES" -gt 500 ]; then
            echo "::warning::PR is large ($CHANGED_LINES lines). Consider splitting into smaller PRs."
          fi

  # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –æ–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
  check-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if docs are updated
        run: |
          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —î –∑–º—ñ–Ω–∏ –≤ src —Ñ–∞–π–ª–∞—Ö
          SRC_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(js|ts|jsx|tsx)$' || true)

          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —î –∑–º—ñ–Ω–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó
          DOCS_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '(README\.md|docs/|\.md$)' || true)

          # –Ø–∫—â–æ –∑–º—ñ–Ω–∏–≤—Å—è –∫–æ–¥ –∞–ª–µ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è - –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
          if [ -n "$SRC_CHANGED" ] && [ -z "$DOCS_CHANGED" ]; then
            echo "::warning::Code changed but documentation not updated. Consider updating README or docs."
          fi

  # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ dependency security
  check-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ code style
  check-code-style:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—Å—ñ—Ö package.json —Ñ–∞–π–ª—ñ–≤
      - name: Check for prettier/eslint configs
        run: |
          echo "Checking code style configuration..."
          # –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É prettier/eslint

  # Labeler - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—î labels –¥–æ PR
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  # –ö–æ–º–µ–Ω—Ç–∞—Ä –∑ –∫–æ—Ä–∏—Å–Ω–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é
  pr-comment:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Comment PR with info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —è–∫—ñ —Å–µ—Ä–≤—ñ—Å–∏ –∑–º—ñ–Ω–∏–ª–∏—Å—è
            const changedServices = new Set();
            files.forEach(file => {
              if (file.filename.startsWith('services/auth-service/')) changedServices.add('Auth Service');
              if (file.filename.startsWith('services/spell-api/')) changedServices.add('Spell Service');
              if (file.filename.startsWith('gateway/')) changedServices.add('Gateway');
              if (file.filename.startsWith('web/')) changedServices.add('Web');
              if (file.filename.startsWith('db/')) changedServices.add('Database');
            });

            // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const additions = files.reduce((sum, file) => sum + file.additions, 0);
            const deletions = files.reduce((sum, file) => sum + file.deletions, 0);

            const comment = `## üìä PR Analysis

### Changed Services
${changedServices.size > 0 ?
  Array.from(changedServices).map(s => `- ${s}`).join('\n') :
  '_No service changes detected_'}

### Code Changes
- **Files changed**: ${files.length}
- **Lines added**: +${additions}
- **Lines removed**: -${deletions}
- **Net change**: ${additions - deletions > 0 ? '+' : ''}${additions - deletions}

### Checklist
- [ ] Tests added/updated
- [ ] Documentation updated
- [ ] CHANGELOG updated (if needed)
- [ ] Environment variables documented (if added)

### Deployment Impact
${changedServices.size > 0 ?
  `‚ö†Ô∏è This PR will trigger rebuild of: ${Array.from(changedServices).join(', ')}` :
  '‚úÖ No service deployments required'}

---
_–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ GitHub Actions_`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
